{% extends "base.html" %}

{% block maincontent %}
<div style="padding: 30px">

<h3 title="Click to change the name" id="projectname">{{project.name|default:"(currently nameless project, click here to give it a name )"}}</h3>
<input title="Press Enter to save the new name" type="text" id="projectname_edit" style="display: none" size="75" placeholder="{{project.name|default:'Enter a project name'}}">
<div>Located in: Dropbox/Apps/Metabotnik{{project.path}}</div>
<div>
    <div class="progress"><span id="num_files_local">Has {{project.num_files_on_dropbox}} files on Dropbox, and {{project.num_files_local}} downloaded</span></div>
</div>
<div>Created on: {{project.created}}</div>
<div>Status: {{project.status}} {% if project.status == 'generating' %}<img src="{{STATIC_URL}}/img/spinner.gif" title="Please wait, now generating your metabotnik">
    
{% endif %}</div>
    <div>
        <a href="sorting" class="button">Sorting</a>
        <a href="#" class="button" id="deleteproject">Delete this project</a>
        {% if project.status != 'downloading' %}
            <a href="#" class="button" id="downloadfiles">Re-sync Dropbox</a>

        {% endif %}
        <input {% if project.public %}checked="1" {% endif %}type="checkbox" id="public" title="If this is checked, all users can see this project"> Published 
    </div>
</div>

<div id="genbox" style="{% if project.status == 'generating' or project.num_files_local != project.num_files_on_dropbox %}display: none;{% endif %}">
    <div style="position: absolute; right: 0; padding-right: 20px">
        <input type="checkbox" id="sendemail" checked="1"> Notify me via email when a task is completed
    </div>
    
     <input type="radio" name="layout" value="horizontal"> horizontal layout<br>
     <input type="radio" name="layout" value="vertical"> vertical layout

    <div style="margin-top: 10px">
    <a href="#" id="makepreview" class="conversionbutton">Make Low-Resolution</a>
    {% if project.status != 'generating' and project.file_path %}        
        <a href="#" id="generate" class="conversionbutton" style="margin-top: 10px">Make Full-Resolution</a>
    {% endif %}
    </div>
</div>


{% if project.preview_width > 0 and project.preview_height > 0 %}
    {% if False and not user.is_anonymous %}    
    <div style="padding: 30px 0 0 10px">
            <a href="#" id="savesection" class="button">Download a Selection</a>
            <div id="savedsections" style="display:none"></div>    
    </div>
    {% endif %}

<div id="preview" class="openseadragon" style="height: 500px; margin-top: 10px"></div>
{% endif %}


{% endblock maincontent %}

{% block extra_javascript_end %}
var num_files_local = {{project.num_files_local}};
var num_files_on_dropbox = {{project.num_files_on_dropbox}};
$(".progress").each(function() {
    $(this).progressbar({
        value: 1
    }).children("span").appendTo(this);
});
function getDownloadProgress() {
    $.get('{% url 'num_files_local' project.pk %}', 
          function(data) {
              num_files_local = parseInt(data);
          }
    );
    if(num_files_local<num_files_on_dropbox) {
        if(num_files_local>0) {
            $('.progress').progressbar( "option", "value", num_files_local/num_files_on_dropbox*100 );
        }        
        var tmp = 'Has {{project.num_files_on_dropbox}} files on Dropbox, and ' + num_files_local + ' downloaded';
        setTimeout(getDownloadProgress, 1000);
    } else {
        var tmp = 'All {{project.num_files_on_dropbox}} files retrieved from Dropbox';
        $('.progress').progressbar( "option", "value", 100 );
        {% if project.status != 'generating' and project.status != 'dzgen' %} $('#genbox').show(); {% endif %}
        
    }
    $('#num_files_local').html(tmp);
}
getDownloadProgress();

{% comment %} If we are doing a generation or dzgen, this takes a long time, so periodically refresh the page...    
{% endcomment %}
{% if project.status == 'generating' or project.status == 'dzgen' %}
setTimeout(function() { document.location = {% url 'projects' %}; }, 10000);
{% endif %}

$('#savesection').click(function(event) {
    event.preventDefault();
    var thelink = $(this);
    thelink.hide();
    $('#savedsections').show();
    $('#savedsections').html('Please wait, making your selection...');
    var slction = viewer1.viewport.viewportToImageRectangle( viewer1.viewport.getBounds() );
    $.post('{% url 'savesection' project.pk %}',
            {'csrfmiddlewaretoken': '{{csrf_token}}',
             'section': slction.x+' '+slction.y+' '+slction.width+' '+slction.height
            },
            function(data) { 
                thelink.show();                
                $('#savedsections').html('<a href="' + data + '">' + data + '</a> (NOTE: this could be a very large file)' );                
            }
    );
});

$('#deleteproject').click(function(event) {
    event.preventDefault();
    var confirmdelete = confirm('Are you sure you want to delete this project?');
    if(confirmdelete) {
        $.post('{% url 'delete_project' project.pk %}',
               {'csrfmiddlewaretoken': '{{csrf_token}}'},
               function(data) {
                    document.location = '{% url 'projects' %}';
               }
        );
    }
});

$('#projectname').click(function(event) {
    event.preventDefault();
    $('#projectname').hide();
    $('#projectname_edit').show().focus();
});
$('#projectname_edit').keyup(function(event) {
    if ( event.which == 13 ) {
        event.preventDefault();
        var name = $(this).val();
        $('#projectname_edit').hide();
        $.post('{% url 'edit_project' project.pk %}',
        {'csrfmiddlewaretoken': '{{csrf_token}}', 
         'name': name, 
        },
        function(data) {
            document.location.reload();
        });
    }
    if ( event.which == 27 ) {
        event.preventDefault();
        $('#projectname_edit').hide();
        $('#projectname').show();
    }  
});
$('#makepreview').click(function(event) {
    event.preventDefault();
    var layout = $('input:radio[name=layout]:checked').val();
    var sendemail = $('#sendemail').val();
    $.post('{% url 'generate' project.pk %}', 
        {'csrfmiddlewaretoken': '{{csrf_token}}', 
         'layout': layout, 
         'preview': 1, 
         'sendemail': $('#sendemail').is(':checked')},
        function(data) {
            document.location.reload();
    });
});
$('#generate').click(function(event) {
    event.preventDefault();
    var layout = $('input:radio[name=layout]:checked').val();
    var sendemail = $('#sendemail').val();        
    $.post('{% url 'generate' project.pk %}', 
        {'csrfmiddlewaretoken': '{{csrf_token}}', 
         'layout': layout, 
         'sendemail': $('#sendemail').is(':checked')},
        function(data) {
            document.location.reload();
    });
});
$('#downloadfiles').click(function(event) {
    event.preventDefault();    
    $.post('{% url 'getdropbox_project' project.pk %}', 
        {'csrfmiddlewaretoken': '{{csrf_token}}'},
        function(data) {
            document.location.reload();
    });    
});
$('#public').click(function(event) {
    var checked = $('#public:checked').val()?'1':'0';
    $.post('{% url 'edit_project' project.pk %}',
        {'csrfmiddlewaretoken': '{{csrf_token}}', 'public': checked }
    );        
});

{% if project.file_path %}
    var viewer1 = OpenSeadragon({
        id:            "preview",
        maxZoomPixelRatio: 100,
        prefixUrl:     '{{STATIC_URL}}openseadragon/images/',
        showNavigator:  false,
        {% if project.deepzoom %}
        tileSources: "/s/project_{{project.pk}}/deepzoom.dzi"
        {% else %}
        tileSources: [
            {
                type: 'legacy-image-pyramid',
                levels: [{"url": "{{csrf_token}}/preview.jpg", 
                          "width": {{project.preview_width}},         
                          "height": {{project.preview_height}}
                         }
                ]
            }
        ]
        {% endif %}
    });
{% endif %}

{% endblock extra_javascript_end %}