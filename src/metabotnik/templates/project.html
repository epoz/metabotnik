{% extends "base.html" %}

{% block maincontent %}
<h3 title="Click to change the name" id="projectname">{{project.name|default:"(currently nameless project)"}}</h3>
<input title="Press Enter to save the new name" type="text" id="projectname_edit" style="display: none" size="75" placeholder="{{project.name|default:'Enter a project name'}}">
<div>{{project.path}}</div>
<div>
    <div class="progress"><span id="num_files_local">Has {{project.num_files_on_dropbox}} files on Dropbox, and {{project.num_files_local}} downloaded</span></div>
</div>
<div>Created on: {{project.created}}</div>
<div>Status: {{project.status}} {% if project.status == 'generating' %}<img src="{{STATIC_URL}}/img/spinner.gif" title="Please wait, now generating your metabotnik">
    
{% endif %}</div>
<div><a href="#" class="button" id="deleteproject">Delete this project</a>
</div>

{% if project.status != 'generating' and project.status != 'done' and project.num_files_local == project.num_files_on_dropbox %}
    <div style="margin-top: 20px; background-color: #eee; padding: 20px">
        <div style="float:right">
            <input type="checkbox" id="sendemail"> Notify me via email when a task is completed
        </div>
        
     <input type="radio" name="layout" value="horizontal"> horizontal layout<br>
     <input type="radio" name="layout" value="vertical"> vertical layout

 
        <div style="margin-top: 10px">
        <a href="#" id="makepreview" class="conversionbutton">Make Low-Resolution</a>
        {% if project.status != 'generating' %}        
            <a href="#" id="generate" class="conversionbutton" style="margin-top: 10px">Make Full-Resolution</a>
        {% endif %}
        </div>
    </div>
{% endif %}

{% if project.preview_width > 0 and project.preview_height > 0 %}
    <div id="preview" class="openseadragon" style="height: 300px; margin-top: 40px"></div>
{% endif %}


{% endblock maincontent %}

{% block extra_javascript_end %}
var num_files_local = {{project.num_files_local}};
var num_files_on_dropbox = {{project.num_files_on_dropbox}};
$(".progress").each(function() {
    $(this).progressbar({
        value: 1
    }).children("span").appendTo(this);
});
function getDownloadProgress() {
    $.get('{% url 'num_files_local' project.pk %}', 
          function(data) {
              num_files_local = parseInt(data);
          }
    );
    if(num_files_local<num_files_on_dropbox) {
        if(num_files_local>0) {
            $('.progress').progressbar( "option", "value", num_files_local/num_files_on_dropbox*100 );
        }        
        var tmp = 'Has {{project.num_files_on_dropbox}} files on Dropbox, and ' + num_files_local + ' downloaded';
        setTimeout(getDownloadProgress, 1000);
    } else {
        var tmp = 'All {{project.num_files_on_dropbox}} files retrieved from Dropbox';
        $('.progress').progressbar( "option", "value", 100 );
    }
    $('#num_files_local').html(tmp);
}
getDownloadProgress();

$('#deleteproject').click(function(event) {
    event.preventDefault();
    var confirmdelete = confirm('Are you sure you want to delete this project?');
    if(confirmdelete) {
        $.post('{% url 'delete_project' project.pk %}',
               {'csrfmiddlewaretoken': '{{csrf_token}}'},
               function(data) {
                    document.location = '{% url 'projects' %}';
               }
        );
    }
});

$('#projectname').click(function(event) {
    event.preventDefault();
    $('#projectname').hide();
    $('#projectname_edit').show().focus();
});
$('#projectname_edit').keyup(function(event) {
    if ( event.which == 13 ) {
        event.preventDefault();
        var name = $(this).val();
        $('#projectname_edit').hide();
        $.post('{% url 'project' project.pk %}',
        {'csrfmiddlewaretoken': '{{csrf_token}}', 
         'name': name, 
        },
        function(data) {
            document.location.reload();
        });
    }
    if ( event.which == 27 ) {
        event.preventDefault();
        $('#projectname_edit').hide();
        $('#projectname').show();
    }  
});
$('#makepreview').click(function(event) {
    event.preventDefault();
    var layout = $('input:radio[name=layout]:checked').val();
    var sendemail = $('#sendemail').val();
    $.post('{% url 'generate' project.pk %}', 
        {'csrfmiddlewaretoken': '{{csrf_token}}', 
         'layout': layout, 
         'preview': 1, 
         'sendemail': $('#sendemail').is(':checked')},
        function(data) {
            document.location.reload();
    });
});
$('#generate').click(function(event) {
    event.preventDefault();    
    $.post('{% url 'generate' project.pk %}', 
        {'csrfmiddlewaretoken': '{{csrf_token}}'},
        function(data) {
            document.location.reload();
    });
});


{% if project.file_path %}
    var viewer1 = OpenSeadragon({
        id:            "preview",
        maxZoomPixelRatio: 100,
        prefixUrl:     '{{STATIC_URL}}openseadragon/images/',
        showNavigator:  false,
        {% if project.deepzoom %}
        tileSources: "/s/project_{{project.pk}}/deepzoom.dzi"
        {% else %}
        tileSources: [
            {
                type: 'legacy-image-pyramid',
                levels: [{"url": "{{csrf_token}}/preview.jpg", 
                          "width": {{project.preview_width}},         
                          "height": {{project.preview_height}}
                         }
                ]
            }
        ]
        {% endif %}
    });
{% endif %}

{% endblock extra_javascript_end %}